## 話すこと

TerraformでIaC化した環境に、Next.jsプロジェクトをデプロイしての振り返り。

## 始めに

これまではバックエンドをGoで書いたり、IaCをCloudFormationやCDKで書いたりしてきた。
今後業務で使うかどうかは置いておき、社内の未使用技術に触れてみたいと思い、Next.jsで作ったアプリケーションをTerraformで構築したECS上にデプロイしてみた。

## Next.js

- チュートリアルに沿って、プロジェクトをセットアップした。
- バックエンドと疎通するアプリケーションを開発する予定だったが、簡素なウェルカムページまでしか作れなかった。
	- Promiseの知識が無くて、axiosの扱いでハマった...。
- `next start`でサーバーが起動するDockerfileを書いて、こちらを使ってビルドしたイメージをデプロイすることにした。
	- の記事を参考にした。
	- チューニングの余地はあるのかな？と思っている。
- デプロイはShellコマンドを作った。イメージをビルドしてプッシュした後にECS Serviceを強制アップデートするといったもの。

## Terraform

- VPC + Subnet + VPC Endpoint + ELB + ECS + ECR の構成を書いた。
- CloudFormationと比べてかなり直感的で書きやすいと感じた。CDKに比べると抽象度は低くプログラミングっぽくないが、個人的にはちょうど良いと感じた。CDKの抽象度の高さや自由度の高さで苦労した経験があった為。
	- 具体的には繰り返しの部分の書き味
	- JSONの書き方
- `terraform import`が便利すぎる
	- Terraform管理下にないAWSリソースを、管理下に取り込むコマンド
	- 取り込み対象のコードを書いて、IDやARNを指定するだけでOK
		- IDなのかARNなのかNameなのかは、Terraformのドキュメントを参照する
- `terraform plan`の差分が綺麗すぎる
	- 変更差分が単純に綺麗で見やすい
- 当然CFnに変換されているのだろうと勘違いしてい多ので、状態管理ファイルが別で存在していることに驚いた
- デプロイが早い
	- CFn経由していないので、内部でSDK呼んでいるっぽい
- Rollbackがない
	- 心配
- HCL
	- for_eachパラメータが便利
	- 一部のパラメータが異なるリソースを作成する際に、複数回リソースの記述をする必要がなくなる
	- mapまたは文字列のsetを渡せる
	- for_eachパラメータが指定されているブロックの中では、`each`オブジェクトが使用可能
			- `each.key`でmapのキーに、`each.value`でmapのバリューにアクセスができる
				- mapではなくsetを渡した場合は、どちらも同じ値となる
	- for_eachで作成したリソースは、for_eachの引数に渡すことができる
	- for式が便利
		- Complex Typeの値から、Complex Typeの値を生成する式
			- Complex Typeとはlist、map、objectなどの複数の値を内包するTypeを指す
		- ECS Serviceの所属するVPC Subnetを指定する際に、事前定義したVPC SubnetからIDだけを抽出したlistを生成して代入するといったことが可能

## インフラの話

- ECSから外向きに通信が走るタイミングがタスク起動時(ECRからイメージを引っ張る時)くらいしかないので、Nat Gateway無駄すぎじゃない？と思って、VPC Endpointを使った。
	- プライベートサブネットからVPC外のサービスにアクセスできる
	- 設定することが思ったより多くてNat Gatewayより大変だった
		- ECRからイメージを取ってきて、ECSタスクを起動するのにS3のVPCエンドポイント、ECRのために二つのVPCエンドポイント、サブネットとの紐つけ、etc...
	- Nat Gatewayより安い
		- Nat Gateway :
		- VPC Endopoint : 
	- インターネットに出ないのでセキュアと言われた時代もあった
		- https://future-architect.github.io/articles/20210618a/

## 終わりに


Terraformの良さを感じられて良かった。書き味もかなり自分好みだったので、moduleとかの便利機能も学んでガンガン使えるようになりたい。
Next.jsはフロントエンドをやったと言えるようなものは作れなかった。だが逆にほとんど何もしていないのにDockerfile書いただけで、すぐにECS上で動いたので(サーバーに関する処理は全くコード書いていない)、インフラはあまり意識せずフロントエンド側の実装に集中できそうなフレームワークなのかなあと感じた。
